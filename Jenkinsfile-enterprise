node {
  try {

    emailext attachLog: true, body: '$PROJECT_NAME - Build Reference # $BUILD_NUMBER \n Build logs can be find at /var/log/jenkins/log/enterprise/$BUILD_NUMBER ',
    compressLog: true, recipientProviders: [developers()],
    subject: '$PROJECT_NAME - Build Ref. Number : $BUILD_NUMBER - Status : Started! - User : $jenkinsUserName', to: '$useremail'

    stage('Checkout') {
		  checkout([
			   $class: 'GitSCM',
			      branches: [
				        [name: "${params.snappybranch}"]
			      ],
			doGenerateSubmoduleConfigurations: false,
			extensions: [],
			submoduleCfg: [],
			userRemoteConfigs: [
				[
          credentialsId: 'a6ad258a-6c79-4d3d-ad34-2b7f58cae36b',
        	url: 'https://github.com/SnappyDataInc/snappydata.git'
				]
			]
		])

		parallel(
			"checkout spark": {
				dir('spark') {
					checkout([
						$class: 'GitSCM',
						branches: [
							[name: "${params.sparkbranch}"]
						],
						doGenerateSubmoduleConfigurations: false,
						extensions: [],
						submoduleCfg: [],
						userRemoteConfigs: [
							[
                credentialsId: 'a6ad258a-6c79-4d3d-ad34-2b7f58cae36b',
              	url: 'https://github.com/SnappyDataInc/spark.git'
							]
						]
					])
				}
			},

			"checkout spark-jobserver": {
				dir('spark-jobserver') {
					checkout([
						$class: 'GitSCM',
						branches: [
							[name: "${params.sparkjobserverbranch}"]
						],
						doGenerateSubmoduleConfigurations: false,
						extensions: [],
						submoduleCfg: [],
						userRemoteConfigs: [
							[
                  credentialsId: 'a6ad258a-6c79-4d3d-ad34-2b7f58cae36b',
              		url: 'https://github.com/SnappyDataInc/spark-jobserver.git'
							]
						]
					])
				}
			},

			"checkout snappy-store": {
				dir('store') {
					checkout([
						$class: 'GitSCM',
						branches: [
							[name: "${params.snappystorebranch}"]
						],
						doGenerateSubmoduleConfigurations: false,
						extensions: [],
						submoduleCfg: [],
						userRemoteConfigs: [
							[
                credentialsId: 'a6ad258a-6c79-4d3d-ad34-2b7f58cae36b',
              	url: 'https://github.com/SnappyDataInc/snappy-store.git'
							]
						]
					])
				}
			},

			"checkout aqp": {
				dir('aqp') {
          checkout(
            [
              $class: 'GitSCM',
              branches: [[name: "${params.aqpbranch}"]],
              doGenerateSubmoduleConfigurations: false,
              extensions: [[$class: 'CleanBeforeCheckout']],
              submoduleCfg: [],
              userRemoteConfigs: [
                [
                  credentialsId: '1ea55eab-c2f5-46e6-a804-53ceb02aebda',
                  url: 'https://github.com/SnappyDataInc/snappy-aqp'
                ]
             ]
          ])
				}
			}
		)
	}

	stage('Build') {
		script {
			sh './gradlew cleanAll'
		}
	}

	stage('Test') {
		script {
			sh "./gradlew ${buildtarget}"
		}
	}

  stage('Copy') {
    fileOperations([folderCreateOperation('/var/log/jenkins/log/oss/$BUILD_NUMBER')])
    fileOperations([folderCopyOperation(destinationFolderPath: '/var/log/jenkins/log/enterprise/$BUILD_NUMBER', sourceFolderPath: '/var/lib/jenkins/workspace/tibco-computedb-ci/build-artifacts')])
  }

  } finally {
	    emailext attachLog: true, body: '$PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS: \n Check console output at $BUILD_URL to view the results.',
	    compressLog: true, recipientProviders: [developers()],
	    subject: '$PROJECT_NAME - Build # $BUILD_NUMBER - $BUILD_STATUS!', to: '$useremail'
  }
}

